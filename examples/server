#!/usr/bin/env php
<?php
require __DIR__ . '/../vendor/autoload.php';

Eloquent\Asplode\Asplode::install();

use Icecave\Stump\Logger;
use PhpAmqpLib\Channel\AMQPChannel;
use Skewd\Server\ModularServer;
use Skewd\Server\Module;
use Skewd\Server\Server;
use Skewd\Server\ServerProcess;

class MyModule implements Module
{
    public function name()
    {
        return 'my-module';
    }

    public function initialize(Server $server/*, AMQPChannel $channel*/)
    {
        if (rand(0, 1))
            throw new \Exception('OH SHIT!');
    }

    public function shutdown()
    {
        if (rand(0, 1))
            throw new \Exception('OH SHIT!');
    }

    public function tick()
    {
        echo '.';
        usleep(500);
        // if (rand(0, 10000) === 0)
        //     throw new \Exception('OH SHIT!');
    }
}

$logger = new Logger;
$server = new ModularServer($logger);
$server->add(new MyModule);

$process = new ServerProcess($server, $logger);
$process->start();
